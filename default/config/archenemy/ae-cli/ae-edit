#!/usr/bin/env bash
#
# Archenemy Configuration Editor
# Interactive config file editor - Bash compatible
set -euo pipefail

EDITOR="${EDITOR:-nvim}"
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
HYPR_DIR="$CONFIG_DIR/hypr"

if [[ -t 1 ]]; then
  RED='\033[0;31m' CYAN='\033[0;36m' BOLD='\033[1m' RESET='\033[0m'
else
  RED='' CYAN='' BOLD='' RESET=''
fi

show_help() {
  cat <<EOF
${BOLD}ae edit${RESET} - Configuration Editor

${BOLD}USAGE:${RESET}
  ae edit [target]

${BOLD}TARGETS:${RESET}
  ${CYAN}hyprland${RESET}      Main Hyprland config
  ${CYAN}envs${RESET}          Environment variables
  ${CYAN}monitors${RESET}      Monitor configuration
  ${CYAN}input${RESET}         Input device settings
  ${CYAN}looknfeel${RESET}     Appearance settings
  ${CYAN}autostart${RESET}     Startup applications
  ${CYAN}windows${RESET}       Window rules
  ${CYAN}bindings${RESET}      Keybinding directory
  ${CYAN}vim${RESET}           Vim navigation bindings
  ${CYAN}apps${RESET}          App-specific rules
  ${CYAN}waybar${RESET}        Waybar configuration
  ${CYAN}mako${RESET}          Mako notifications
  ${CYAN}kitty${RESET}         Kitty terminal

If no target specified, shows interactive menu (requires fzf).
EOF
}

edit_file() {
  local file="$1"
  if [[ ! -f "$file" ]]; then
    echo -e "${RED}Error:${RESET} File not found: $file"
    exit 1
  fi
  $EDITOR "$file"
}

show_menu() {
  if ! command -v fzf &>/dev/null; then
    echo -e "${RED}Error:${RESET} fzf required for interactive mode"
    echo "Specify a target: ae edit hyprland"
    exit 1
  fi

  local -a files=(
    "hyprland.conf:$HYPR_DIR/hyprland.conf"
    "envs.conf:$HYPR_DIR/envs.conf"
    "monitors.conf:$HYPR_DIR/monitors.conf"
    "input.conf:$HYPR_DIR/input.conf"
    "looknfeel.conf:$HYPR_DIR/looknfeel.conf"
    "autostart.conf:$HYPR_DIR/autostart.conf"
    "windows.conf:$HYPR_DIR/windows.conf"
    "vim-nav.conf:$HYPR_DIR/bindings/vim-nav.conf"
    "apps.conf:$HYPR_DIR/bindings/apps.conf"
    "tiling.conf:$HYPR_DIR/bindings/tiling.conf"
    "waybar:$CONFIG_DIR/waybar/config"
    "mako:$CONFIG_DIR/mako/config"
    "kitty:$CONFIG_DIR/kitty/kitty.conf"
  )

  local choice
  choice=$(printf '%s\n' "${files[@]}" | cut -d: -f1 | fzf --header="Select config to edit")

  if [[ -n "$choice" ]]; then
    for entry in "${files[@]}"; do
      if [[ "${entry%%:*}" == "$choice" ]]; then
        edit_file "${entry#*:}"
        break
      fi
    done
  fi
}

main() {
  local target="${1:-}"

  case "$target" in
  hyprland)
    edit_file "$HYPR_DIR/hyprland.conf"
    ;;
  envs)
    edit_file "$HYPR_DIR/envs.conf"
    ;;
  monitors)
    edit_file "$HYPR_DIR/monitors.conf"
    ;;
  input)
    edit_file "$HYPR_DIR/input.conf"
    ;;
  looknfeel)
    edit_file "$HYPR_DIR/looknfeel.conf"
    ;;
  autostart)
    edit_file "$HYPR_DIR/autostart.conf"
    ;;
  windows)
    edit_file "$HYPR_DIR/windows.conf"
    ;;
  bindings)
    cd "$HYPR_DIR/bindings" && $EDITOR .
    ;;
  vim)
    edit_file "$HYPR_DIR/bindings/vim-nav.conf"
    ;;
  apps)
    cd "$HYPR_DIR/apps" && $EDITOR .
    ;;
  waybar)
    edit_file "$CONFIG_DIR/waybar/config"
    ;;
  mako)
    edit_file "$CONFIG_DIR/mako/config"
    ;;
  kitty)
    edit_file "$CONFIG_DIR/kitty/kitty.conf"
    ;;
  --help | -h)
    show_help
    ;;
  "")
    show_menu
    ;;
    *)
      echo -e "${RED}Error:${RESET} Unknown target '$target'"
      echo "Run ${CYAN}ae edit --help${RESET} for valid targets"
      exit 1
      ;;
  esac
}

main "$@"
