#!/usr/bin/env bash
#
# Archenemy Keybinding Reference
# Display and search keybindings - Bash compatible
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
KEYBINDINGS_FILE="$SCRIPT_DIR/../../../graphics/hypr/KEYBINDINGS.md"
REF_DIR="$SCRIPT_DIR/reference"

if [[ -t 1 ]]; then
  RED='\033[0;31m' CYAN='\033[0;36m' BOLD='\033[1m' RESET='\033[0m'
else
  RED='' CYAN='' BOLD='' RESET=''
fi

show_help() {
  cat <<EOF
${BOLD}ae keys${RESET} - Keybinding Reference

${BOLD}USAGE:${RESET}
  ae keys [options]

${BOLD}OPTIONS:${RESET}
  ${CYAN}--layer, -l${RESET} <name>   Show specific layer (super/shift/ctrl/alt/special)
  ${CYAN}--search, -s${RESET}         Interactive search (requires fzf)
  ${CYAN}--vim, -v${RESET}            Show Vim parallels
  ${CYAN}--cheat, -c${RESET}          Compact cheat sheet
  ${CYAN}--live${RESET}               Show live Hyprland bindings
  ${CYAN}--help, -h${RESET}           Show this help

${BOLD}EXAMPLES:${RESET}
  ae keys              # Show full layout
  ae keys -l super     # Show SUPER layer only
  ae keys -s           # Interactive search
  ae keys -v           # Vim equivalents
EOF
}

show_full() {
  if [[ -f "$KEYBINDINGS_FILE" ]] && command -v bat &>/dev/null; then
    bat --style=plain --paging=always "$KEYBINDINGS_FILE"
  elif [[ -f "$KEYBINDINGS_FILE" ]]; then
    less "$KEYBINDINGS_FILE"
  else
    echo -e "${RED}Error:${RESET} KEYBINDINGS.md not found"
    exit 1
  fi
}

show_layer() {
  local layer="$1"
  if [[ ! -f "$KEYBINDINGS_FILE" ]]; then
    echo -e "${RED}Error:${RESET} KEYBINDINGS.md not found"
    exit 1
  fi

  case "$layer" in
  super | base)
    sed -n '/^## SUPER Layer/,/^## /p' "$KEYBINDINGS_FILE" | head -n -1 | ${PAGER:-less}
    ;;
  shift)
    sed -n '/^## SHIFT Layer/,/^## /p' "$KEYBINDINGS_FILE" | head -n -1 | ${PAGER:-less}
    ;;
  ctrl)
    sed -n '/^## CTRL Layer/,/^## /p' "$KEYBINDINGS_FILE" | head -n -1 | ${PAGER:-less}
    ;;
  alt)
    sed -n '/^## ALT Layer/,/^## /p' "$KEYBINDINGS_FILE" | head -n -1 | ${PAGER:-less}
    ;;
  special)
    sed -n '/^## Special Keys/,/^## /p' "$KEYBINDINGS_FILE" | head -n -1 | ${PAGER:-less}
    ;;
  *)
    echo -e "${RED}Error:${RESET} Unknown layer '$layer'"
    echo "Valid layers: super, shift, ctrl, alt, special"
    exit 1
    ;;
  esac
}

show_search() {
  if ! command -v fzf &>/dev/null; then
    echo -e "${RED}Error:${RESET} fzf not found. Install with: sudo pacman -S fzf"
    exit 1
  fi

  if [[ -f "$REF_DIR/keybindings.txt" ]]; then
    grep -v "^#" "$REF_DIR/keybindings.txt" | fzf --header="Search Keybindings" --preview-window=wrap
  else
    echo -e "${RED}Error:${RESET} keybindings.txt not found"
    exit 1
  fi
}

show_vim() {
  if [[ -f "$REF_DIR/vim-parallels.txt" ]]; then
    cat "$REF_DIR/vim-parallels.txt" | ${PAGER:-less}
  else
    echo -e "${RED}Error:${RESET} vim-parallels.txt not found"
    exit 1
  fi
}

show_cheat() {
  cat <<EOF
${BOLD}Archenemy Quick Reference${RESET}

${CYAN}NAVIGATION${RESET}
  SUPER + hjkl/arrows    Move focus
  SUPER + SHIFT + hjkl   Swap windows
  SUPER + o              Cycle window focus

${CYAN}WORKSPACES${RESET}
  SUPER + 1-9            Switch workspace
  SUPER + SHIFT + 1-9    Move window to workspace
  SUPER + TAB            Next workspace
  SUPER + CTRL + TAB     Previous workspace

${CYAN}WINDOW STATES${RESET}
  SUPER + w/q            Close window
  SUPER + v              Toggle floating
  SUPER + f              Toggle fullscreen
  SUPER + m              Toggle maximize
  SUPER + p              Pin window

${CYAN}APPLICATIONS${RESET}
  SUPER + RETURN         Terminal
  SUPER + b              Browser
  SUPER + /              Search (launcher)
  SUPER + r              Run command

${CYAN}SYSTEM${RESET}
  SUPER + CTRL + n       Toggle nightlight
  SUPER + CTRL + i       Toggle idle/lock
  SUPER + SHIFT + s      Screenshot area
EOF
}

show_live() {
  if ! command -v hyprctl &>/dev/null; then
    echo -e "${RED}Error:${RESET} Hyprland not running"
    exit 1
  fi

  hyprctl binds | ${PAGER:-less}
}

main() {
  local mode="${1:-}"

  case "$mode" in
  --layer | -l)
    show_layer "${2:-}"
    ;;
  --search | -s)
    show_search
    ;;
  --vim | -v)
    show_vim
    ;;
  --cheat | -c)
    show_cheat
    ;;
  --live)
    show_live
    ;;
  --help | -h)
    show_help
    ;;
  "")
    show_full
    ;;
  *)
    echo -e "${RED}Error:${RESET} Unknown option '$mode'"
    echo "Run ${CYAN}ae keys --help${RESET} for usage"
    exit 1
    ;;
  esac
}

main "$@"
