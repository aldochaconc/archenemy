#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=./common.sh
source "$SCRIPT_DIR/common.sh"

STATE_DIR="$ARCHENEMY_ARCHINSTALL_DIR"
SENTINEL_FILE="$STATE_DIR/postinstall-required"
PROFILE_TARGET="/etc/profile.d/archenemy-postinstall.sh"
PROFILE_TEMPLATE="$ARCHENEMY_DEFAULTS_INSTALL_SENTINEL_DIR/postinstall-profile.sh"
BOOT_ENTRY="$SCRIPT_DIR/boot.sh"

usage() {
  cat <<'USAGE'
Usage: installation/install-sentinel [register|remove] [--dry-run]

Commands:
  register   Create the sentinel and install the /etc/profile.d hook (default)
  remove     Delete the sentinel file and remove the profile hook

Options:
  --dry-run  Print commands without executing them
  -h, --help Show this message
USAGE
}

cleanup() {
  local file="$1"
  [[ -n "$file" && -f "$file" ]] && rm -f "$file"
}

render_profile_template() {
  if [[ ! -f "$PROFILE_TEMPLATE" ]]; then
    log_error "Missing profile template at $PROFILE_TEMPLATE."
    exit 1
  fi
  local tmp
  tmp="$(mktemp)"
  sed \
    -e "s|{{SENTINEL_PATH}}|$SENTINEL_FILE|g" \
    -e "s|{{BOOT_PATH}}|$BOOT_ENTRY|g" \
    "$PROFILE_TEMPLATE" >"$tmp"
  echo "$tmp"
}

register_prompt() {
  log_info "Registering post-install sentinel at $SENTINEL_FILE..."
  run_cmd install -d -m 755 "$STATE_DIR"
  run_cmd touch "$SENTINEL_FILE"
  run_cmd sudo install -d -m 755 /etc/profile.d

  local rendered
  rendered="$(render_profile_template)"
  run_cmd sudo install -m 644 "$rendered" "$PROFILE_TARGET"
  cleanup "$rendered"

  log_success "Post-install login prompt installed at $PROFILE_TARGET."
}

remove_prompt() {
  log_info "Removing post-install sentinel from $SENTINEL_FILE..."
  if [[ -f "$SENTINEL_FILE" ]]; then
    run_cmd rm -f "$SENTINEL_FILE"
  fi
  if [[ -f "$PROFILE_TARGET" ]]; then
    run_cmd sudo rm -f "$PROFILE_TARGET"
  fi
  if [[ -d "$STATE_DIR" && -z "$(ls -A "$STATE_DIR")" ]]; then
    run_cmd rmdir "$STATE_DIR"
  fi
  log_success "Post-install prompt assets removed."
}

main() {
  parse_cli_args "$@"

  local positional=()
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -h|--help)
        usage
        exit 0
        ;;
      --dry-run)
        shift
        ;;
      *)
        positional+=("$1")
        shift
        ;;
    esac
  done

  local command="${positional[0]:-register}"
  case "$command" in
    register)
      register_prompt
      ;;
    remove)
      remove_prompt
      ;;
    *)
      usage
      exit 1
      ;;
  esac
}

main "$@"
